<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Étape par étape - Réseau Métro</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Segoe UI", system-ui, sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 30%, #1a4d6e 60%, #0d2d4a 100%);
      background-attachment: fixed;
      padding: 24px;
      color: #e8eef4;
    }
    .glass {
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(14px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      padding: 20px;
    }
    .page-title { text-align: center; margin-bottom: 12px; font-size: 1.5rem; }
    .main-nav {
      display: flex; justify-content: center; gap: 0; margin-bottom: 24px; padding: 0 16px;
    }
    .main-nav-link {
      padding: 12px 28px; color: rgba(255,255,255,0.75); text-decoration: none; font-size: 1rem; font-weight: 500;
      border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s;
    }
    .main-nav-link:hover { color: #fff; }
    .main-nav-link.active { color: #fff; border-bottom-color: #7dd3fc; }
    .user-guide.steps-guide {
      font-size: 0.9rem; color: rgba(255,255,255,0.85); padding: 12px 16px; border-radius: 10px;
      background: rgba(255,255,255,0.06); border: 1px dashed rgba(255,255,255,0.2); margin-bottom: 20px; line-height: 1.5;
    }
    .steps-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-bottom: 20px;
    }
    .steps-controls label { font-size: 0.95rem; }
    .steps-controls select {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.3);
      background: #1e3a5f;
      color: #e8eef4;
      font-size: 0.95rem;
      cursor: pointer;
    }
    .steps-controls select option {
      background: #1e3a5f;
      color: #e8eef4;
    }
    .steps-controls button {
      padding: 10px 20px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.4);
      background: rgba(99, 179, 237, 0.5);
      color: #fff;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .steps-controls button:hover { background: rgba(99, 179, 237, 0.7); }
    .steps-controls button:disabled { opacity: 0.5; cursor: not-allowed; }
    .steps-nav {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .steps-nav button {
      padding: 8px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.2);
      color: #fff;
      cursor: pointer;
    }
    .steps-nav button:hover { background: rgba(255,255,255,0.3); }
    .steps-nav span { font-size: 0.95rem; }
    .graph-container {
      width: 100%;
      max-width: 600px;
      height: 500px;
      margin: 0 auto 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .graph-container svg { max-width: 100%; max-height: 100%; }
    .matrix-container { margin: 0 auto 20px; max-width: 600px; overflow: auto; }
    .matrix-caption { font-size: 0.9rem; margin-bottom: 8px; color: rgba(255,255,255,0.9); }
    .matrix-wrap table { border-collapse: collapse; font-size: 12px; margin: 0 auto; }
    .matrix-wrap th, .matrix-wrap td { border: 1px solid rgba(255,255,255,0.3); padding: 6px 10px; text-align: center; min-width: 32px; background: rgba(0,0,0,0.2); color: #e8eef4; }
    .matrix-wrap th { background: rgba(255,255,255,0.15); font-weight: 600; }
    .matrix-wrap td.highlight-k { background: rgba(99, 179, 237, 0.4); }
    .step-desc {
      padding: 16px 20px;
      font-size: 0.95rem;
      line-height: 1.5;
      background: rgba(255,255,255,0.08);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.15);
      margin-bottom: 12px;
      min-height: 60px;
    }
    .step-extra {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.8);
      margin-top: 8px;
    }
    .step-extra pre { overflow-x: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1 class="page-title glass">Réseau Métro (19 stations)</h1>
  <nav class="main-nav glass" aria-label="Navigation principale">
    <a href="/" class="main-nav-link">Résultat</a>
    <a href="/steps" class="main-nav-link active">Étape par étape</a>
  </nav>

  {% if not graph_available %}
  <div class="glass" style="margin-bottom:20px; color:#fff3cd;">
    <strong>Données manquantes.</strong> Exécutez d'abord : <code>python algorithms/graph_network.py</code>
  </div>
  {% endif %}

  <div class="glass">
    <p class="user-guide steps-guide">
      <strong>Guide :</strong> Choisissez un algorithme et la station de départ, puis cliquez sur « Charger les étapes ». Utilisez les boutons <strong>Précédent</strong> / <strong>Suivant</strong> pour parcourir chaque étape. Le graphe utilise le même placement que la visualisation « Résultat » (réseau métro).
    </p>
    <div class="steps-controls">
      <label>Algorithme :</label>
      <select id="algo">
        <option value="bfs">BFS (parcours)</option>
        <option value="dfs">DFS (parcours)</option>
        <option value="dijkstra">Dijkstra (PCC)</option>
        <option value="bellman_ford">Bellman-Ford (PCC)</option>
        <option value="floyd_warshall">Floyd-Warshall (toutes paires)</option>
        <option value="prim">Prim (MST)</option>
        <option value="kruskal">Kruskal (MST)</option>
      </select>
      <label>Station de départ :</label>
      <select id="start">
        {% for i in range(n_stations) %}
        <option value="{{ i }}" {% if i == 10 %}selected{% endif %}>{{ i }}</option>
        {% endfor %}
      </select>
      <button type="button" id="btnLoad">Charger les étapes</button>
    </div>

    <div id="stepsPanel" style="display: none;">
      <div class="steps-nav">
        <button type="button" id="btnPrev">← Précédent</button>
        <span id="stepCounter">Étape 0 / 0</span>
        <button type="button" id="btnNext">Suivant →</button>
      </div>
      <div class="graph-container" id="graphContainer">
        <svg id="graphSvg" width="500" height="450" viewBox="0 0 500 450"></svg>
      </div>
      <div class="matrix-container" id="matrixContainer" style="display: none;">
        <p class="matrix-caption">Matrice des distances (départ → arrivée)</p>
        <div class="matrix-wrap" id="matrixWrap"></div>
      </div>
      <div class="step-desc" id="stepDesc">—</div>
      <div class="step-extra" id="stepExtra"></div>
    </div>

    <div id="stepsPlaceholder" style="text-align:center; color: rgba(255,255,255,0.6); padding: 40px;">
      Cliquez sur « Charger les étapes » pour afficher le graphe et les étapes.
    </div>
  </div>

  <script>
    (function () {
      const algoSelect = document.getElementById("algo");
      const startSelect = document.getElementById("start");
      const btnLoad = document.getElementById("btnLoad");
      const btnPrev = document.getElementById("btnPrev");
      const btnNext = document.getElementById("btnNext");
      const stepCounter = document.getElementById("stepCounter");
      const stepDesc = document.getElementById("stepDesc");
      const stepExtra = document.getElementById("stepExtra");
      const graphSvg = document.getElementById("graphSvg");
      const graphContainer = document.getElementById("graphContainer");
      const matrixContainer = document.getElementById("matrixContainer");
      const matrixWrap = document.getElementById("matrixWrap");
      const stepsPanel = document.getElementById("stepsPanel");
      const stepsPlaceholder = document.getElementById("stepsPlaceholder");

      let state = { graph: null, steps: [], index: 0, startNode: 10, algo: "" };

      function getLayout(nodes) {
        if (state.graph && state.graph.positions) {
          const pos = {};
          nodes.forEach(function (node) {
            const p = state.graph.positions[String(node)];
            if (p) pos[node] = { x: p[0], y: p[1] };
          });
          if (Object.keys(pos).length === nodes.length) return pos;
        }
        const n = nodes.length;
        const cx = 250, cy = 220, r = 180;
        const pos = {};
        nodes.forEach((node, i) => {
          const angle = (2 * Math.PI * i) / n - Math.PI / 2;
          pos[node] = { x: cx + r * Math.cos(angle), y: cy + r * Math.sin(angle) };
        });
        return pos;
      }

      function renderMatrix(step) {
        matrixWrap.innerHTML = "";
        if (!step.matrix || !step.matrix.length) return;
        const n = step.matrix.length;
        const k = step.k;
        const table = document.createElement("table");
        let tr = document.createElement("tr");
        tr.appendChild(document.createElement("th"));
        for (let j = 0; j < n; j++) {
          const th = document.createElement("th");
          th.textContent = j;
          if (k >= 0 && j === k) th.className = "highlight-k";
          tr.appendChild(th);
        }
        table.appendChild(tr);
        for (let i = 0; i < n; i++) {
          tr = document.createElement("tr");
          const th = document.createElement("th");
          th.textContent = i;
          if (k >= 0 && i === k) th.className = "highlight-k";
          tr.appendChild(th);
          for (let j = 0; j < n; j++) {
            const td = document.createElement("td");
            td.textContent = step.matrix[i][j];
            if (k >= 0 && (i === k || j === k)) td.className = "highlight-k";
            tr.appendChild(td);
          }
          table.appendChild(tr);
        }
        matrixWrap.appendChild(table);
      }

      function renderGraph(step) {
        if (!state.graph) return;
        const nodes = state.graph.nodes;
        const edges = state.graph.edges;
        const pos = getLayout(nodes);
        let visited = step.visited || [];
        if (visited.length === 0 && step.distances) {
          visited = Object.keys(step.distances).filter(function (n) {
            return step.distances[n] !== "inf" && step.distances[n] !== undefined;
          }).map(Number);
        }
        const current = step.current_node;
        const queue = step.queue || [];
        const stack = step.stack || [];
        const mstEdges = step.mst_edges ? step.mst_edges.map(e => [e[0], e[1]]) : [];
        const distances = step.distances || {};

        const svgNS = "http://www.w3.org/2000/svg";
        graphSvg.innerHTML = "";
        const gEdges = document.createElementNS(svgNS, "g");
        const gNodes = document.createElementNS(svgNS, "g");

        edges.forEach(e => {
          const u = e.from, v = e.to, w = e.weight;
          const line = document.createElementNS(svgNS, "line");
          const x1 = pos[u].x, y1 = pos[u].y, x2 = pos[v].x, y2 = pos[v].y;
          line.setAttribute("x1", x1); line.setAttribute("y1", y1);
          line.setAttribute("x2", x2); line.setAttribute("y2", y2);
          const inMst = mstEdges.some(([a, b]) => (a === u && b === v) || (a === v && b === u));
          line.setAttribute("stroke", inMst ? "#3b82f6" : "rgba(255,255,255,0.25)");
          line.setAttribute("stroke-width", inMst ? 3 : 1);
          gEdges.appendChild(line);
          const midX = (x1 + x2) / 2, midY = (y1 + y2) / 2;
          const text = document.createElementNS(svgNS, "text");
          text.setAttribute("x", midX); text.setAttribute("y", midY);
          text.setAttribute("fill", "rgba(255,255,255,0.9)"); text.setAttribute("font-size", "10");
          text.setAttribute("text-anchor", "middle"); text.textContent = w;
          gEdges.appendChild(text);
        });
        graphSvg.appendChild(gEdges);

        nodes.forEach(node => {
          const circle = document.createElementNS(svgNS, "circle");
          circle.setAttribute("cx", pos[node].x); circle.setAttribute("cy", pos[node].y);
          circle.setAttribute("r", 18);
          let fill = "rgba(255,255,255,0.2)";
          if (current === node) fill = "#ef4444";
          else if (visited.indexOf(node) !== -1) fill = "#22c55e";
          else if (queue.indexOf(node) !== -1 || stack.indexOf(node) !== -1) fill = "#eab308";
          circle.setAttribute("fill", fill);
          circle.setAttribute("stroke", "rgba(255,255,255,0.6)");
          circle.setAttribute("stroke-width", 2);
          gNodes.appendChild(circle);
          const label = document.createElementNS(svgNS, "text");
          label.setAttribute("x", pos[node].x); label.setAttribute("y", pos[node].y + 5);
          label.setAttribute("fill", "#fff"); label.setAttribute("font-size", "12");
          label.setAttribute("text-anchor", "middle"); label.textContent = node;
          gNodes.appendChild(label);
        });
        graphSvg.appendChild(gNodes);
      }

      function formatExtra(step) {
        const parts = [];
        if (step.distances && Object.keys(step.distances).length) {
          const d = step.distances;
          parts.push("Distances: " + Object.keys(d).sort((a, b) => Number(a) - Number(b)).map(n => n + "→" + d[n]).join(", "));
        }
        if (step.mst_edges && step.mst_edges.length) parts.push("Arêtes MST: " + step.mst_edges.length);
        if (step.total_weight != null) parts.push("Poids total: " + step.total_weight);
        return parts.length ? parts.join(" · ") : "";
      }

      function showStep() {
        const step = state.steps[state.index];
        if (!step) return;
        stepDesc.textContent = step.description;
        stepExtra.innerHTML = formatExtra(step) ? "<pre>" + formatExtra(step) + "</pre>" : "";
        stepCounter.textContent = "Étape " + (state.index + 1) + " / " + state.steps.length;
        btnPrev.disabled = state.index <= 0;
        btnNext.disabled = state.index >= state.steps.length - 1;
        if (step.matrix) {
          graphContainer.style.display = "none";
          matrixContainer.style.display = "block";
          renderMatrix(step);
        } else {
          graphContainer.style.display = "flex";
          matrixContainer.style.display = "none";
          renderGraph(step);
        }
      }

      btnLoad.addEventListener("click", function () {
        const algo = algoSelect.value;
        const start = parseInt(startSelect.value, 10);
        fetch("/api/steps/" + algo + "?start=" + start)
          .then(function (r) { return r.ok ? r.json() : Promise.reject(new Error(r.statusText)); })
          .then(function (data) {
            state.graph = data.graph || {};
            state.steps = data.steps;
            state.index = 0;
            state.startNode = data.start_node;
            state.algo = data.algo || "";
            stepsPlaceholder.style.display = "none";
            stepsPanel.style.display = "block";
            showStep();
          })
          .catch(function (err) {
            alert("Erreur: " + err.message);
          });
      });

      btnPrev.addEventListener("click", function () {
        if (state.index > 0) { state.index--; showStep(); }
      });
      btnNext.addEventListener("click", function () {
        if (state.index < state.steps.length - 1) { state.index++; showStep(); }
      });
    })();
  </script>
</body>
</html>
